{"title": "How to prevent SQL injection in PHP?", "content": "<div class=\"post-text\">\n<p><strong>Use prepared statements and parameterized queries.</strong>\u00a0These are SQL statements that are sent to and parsed by the database server separately from any parameters. This way it is impossible for an attacker to inject malicious SQL.</p>\n<p>You basically have two options to achieve this:</p>\n<ol>\n<li>Using\u00a0<a href=\"http://php.net/manual/en/book.pdo.php\" rel=\"noreferrer\">PDO</a>\u00a0(for any supported database driver):\n<pre class=\"lang-php prettyprint prettyprinted\"><code>&lt;span class=\"pln\"&gt;$stmt &lt;/span&gt;&lt;span class=\"pun\"&gt;=&lt;/span&gt;&lt;span class=\"pln\"&gt; $pdo&lt;/span&gt;&lt;span class=\"pun\"&gt;-&amp;gt;&lt;/span&gt;&lt;span class=\"pln\"&gt;prepare&lt;/span&gt;&lt;span class=\"pun\"&gt;(&lt;/span&gt;&lt;span class=\"str\"&gt;'SELECT * FROM employees WHERE name = :name'&lt;/span&gt;&lt;span class=\"pun\"&gt;);&lt;/span&gt;&lt;span class=\"pln\"&gt;\n\n$stmt&lt;/span&gt;&lt;span class=\"pun\"&gt;-&amp;gt;&lt;/span&gt;&lt;span class=\"pln\"&gt;execute&lt;/span&gt;&lt;span class=\"pun\"&gt;(&lt;/span&gt;&lt;span class=\"pln\"&gt;array&lt;/span&gt;&lt;span class=\"pun\"&gt;(&lt;/span&gt;&lt;span class=\"str\"&gt;'name'&lt;/span&gt; &lt;span class=\"pun\"&gt;=&amp;gt;&lt;/span&gt;&lt;span class=\"pln\"&gt; $name&lt;/span&gt;&lt;span class=\"pun\"&gt;));&lt;/span&gt;\n\n&lt;span class=\"kwd\"&gt;foreach&lt;/span&gt; &lt;span class=\"pun\"&gt;(&lt;/span&gt;&lt;span class=\"pln\"&gt;$stmt &lt;/span&gt;&lt;span class=\"kwd\"&gt;as&lt;/span&gt;&lt;span class=\"pln\"&gt; $row&lt;/span&gt;&lt;span class=\"pun\"&gt;)&lt;/span&gt; &lt;span class=\"pun\"&gt;{&lt;/span&gt;\n    &lt;span class=\"com\"&gt;// do something with $row&lt;/span&gt;\n&lt;span class=\"pun\"&gt;}&lt;/span&gt;</code></code></pre>\n</li>\n<li>Using\u00a0<a href=\"http://php.net/manual/en/book.mysqli.php\" rel=\"noreferrer\">MySQLi</a>\u00a0(for MySQL):\n<pre class=\"lang-php prettyprint prettyprinted\"><code>&lt;span class=\"pln\"&gt;$stmt &lt;/span&gt;&lt;span class=\"pun\"&gt;=&lt;/span&gt;&lt;span class=\"pln\"&gt; $dbConnection&lt;/span&gt;&lt;span class=\"pun\"&gt;-&amp;gt;&lt;/span&gt;&lt;span class=\"pln\"&gt;prepare&lt;/span&gt;&lt;span class=\"pun\"&gt;(&lt;/span&gt;&lt;span class=\"str\"&gt;'SELECT * FROM employees WHERE name = ?'&lt;/span&gt;&lt;span class=\"pun\"&gt;);&lt;/span&gt;&lt;span class=\"pln\"&gt;\n$stmt&lt;/span&gt;&lt;span class=\"pun\"&gt;-&amp;gt;&lt;/span&gt;&lt;span class=\"pln\"&gt;bind_param&lt;/span&gt;&lt;span class=\"pun\"&gt;(&lt;/span&gt;&lt;span class=\"str\"&gt;'s'&lt;/span&gt;&lt;span class=\"pun\"&gt;,&lt;/span&gt;&lt;span class=\"pln\"&gt; $name&lt;/span&gt;&lt;span class=\"pun\"&gt;);&lt;/span&gt; &lt;span class=\"com\"&gt;// 's' specifies the variable type =&amp;gt; 'string'&lt;/span&gt;&lt;span class=\"pln\"&gt;\n\n$stmt&lt;/span&gt;&lt;span class=\"pun\"&gt;-&amp;gt;&lt;/span&gt;&lt;span class=\"pln\"&gt;execute&lt;/span&gt;&lt;span class=\"pun\"&gt;();&lt;/span&gt;&lt;span class=\"pln\"&gt;\n\n$result &lt;/span&gt;&lt;span class=\"pun\"&gt;=&lt;/span&gt;&lt;span class=\"pln\"&gt; $stmt&lt;/span&gt;&lt;span class=\"pun\"&gt;-&amp;gt;&lt;/span&gt;&lt;span class=\"pln\"&gt;get_result&lt;/span&gt;&lt;span class=\"pun\"&gt;();&lt;/span&gt;\n&lt;span class=\"kwd\"&gt;while&lt;/span&gt; &lt;span class=\"pun\"&gt;(&lt;/span&gt;&lt;span class=\"pln\"&gt;$row &lt;/span&gt;&lt;span class=\"pun\"&gt;=&lt;/span&gt;&lt;span class=\"pln\"&gt; $result&lt;/span&gt;&lt;span class=\"pun\"&gt;-&amp;gt;&lt;/span&gt;&lt;span class=\"pln\"&gt;fetch_assoc&lt;/span&gt;&lt;span class=\"pun\"&gt;())&lt;/span&gt; &lt;span class=\"pun\"&gt;{&lt;/span&gt;\n    &lt;span class=\"com\"&gt;// do something with $row&lt;/span&gt;\n&lt;span class=\"pun\"&gt;}&lt;/span&gt;</code></code></pre>\n</li>\n</ol>\n<p>If you&#8217;re connecting to a database other than MySQL, there is a driver-specific second option that you can refer to (e.g.\u00a0<code>pg_prepare()</code>\u00a0and\u00a0<code>pg_execute()</code>\u00a0for PostgreSQL). PDO is the universal option.</p>\n<h2>Correctly setting up the connection</h2>\n<p>Note that when using\u00a0<code>PDO</code>\u00a0to access a MySQL database\u00a0<em>real</em>\u00a0prepared statements are\u00a0<strong>not used by default</strong>. To fix this you have to disable the emulation of prepared statements. An example of creating a connection using PDO is:</p>\n<pre class=\"lang-php prettyprint prettyprinted\"><code>&lt;span class=\"pln\"&gt;$dbConnection &lt;/span&gt;&lt;span class=\"pun\"&gt;=&lt;/span&gt; &lt;span class=\"kwd\"&gt;new&lt;/span&gt;&lt;span class=\"pln\"&gt; PDO&lt;/span&gt;&lt;span class=\"pun\"&gt;(&lt;/span&gt;&lt;span class=\"str\"&gt;'mysql:dbname=dbtest;host=127.0.0.1;charset=utf8'&lt;/span&gt;&lt;span class=\"pun\"&gt;,&lt;/span&gt; &lt;span class=\"str\"&gt;'user'&lt;/span&gt;&lt;span class=\"pun\"&gt;,&lt;/span&gt; &lt;span class=\"str\"&gt;'pass'&lt;/span&gt;&lt;span class=\"pun\"&gt;);&lt;/span&gt;&lt;span class=\"pln\"&gt;\n\n$dbConnection&lt;/span&gt;&lt;span class=\"pun\"&gt;-&amp;gt;&lt;/span&gt;&lt;span class=\"pln\"&gt;setAttribute&lt;/span&gt;&lt;span class=\"pun\"&gt;(&lt;/span&gt;&lt;span class=\"pln\"&gt;PDO&lt;/span&gt;&lt;span class=\"pun\"&gt;::&lt;/span&gt;&lt;span class=\"pln\"&gt;ATTR_EMULATE_PREPARES&lt;/span&gt;&lt;span class=\"pun\"&gt;,&lt;/span&gt; &lt;span class=\"kwd\"&gt;false&lt;/span&gt;&lt;span class=\"pun\"&gt;);&lt;/span&gt;&lt;span class=\"pln\"&gt;\n$dbConnection&lt;/span&gt;&lt;span class=\"pun\"&gt;-&amp;gt;&lt;/span&gt;&lt;span class=\"pln\"&gt;setAttribute&lt;/span&gt;&lt;span class=\"pun\"&gt;(&lt;/span&gt;&lt;span class=\"pln\"&gt;PDO&lt;/span&gt;&lt;span class=\"pun\"&gt;::&lt;/span&gt;&lt;span class=\"pln\"&gt;ATTR_ERRMODE&lt;/span&gt;&lt;span class=\"pun\"&gt;,&lt;/span&gt;&lt;span class=\"pln\"&gt; PDO&lt;/span&gt;&lt;span class=\"pun\"&gt;::&lt;/span&gt;&lt;span class=\"pln\"&gt;ERRMODE_EXCEPTION&lt;/span&gt;&lt;span class=\"pun\"&gt;);&lt;/span&gt;</code></code></pre>\n<p>In the above example the error mode isn&#8217;t strictly necessary,\u00a0<strong>but it is advised to add it</strong>. This way the script will not stop with a\u00a0<code>Fatal Error</code>\u00a0when something goes wrong. And it gives the developer the chance to\u00a0<code>catch</code>\u00a0any error(s) which are\u00a0<code>throw</code>n as\u00a0<code>PDOException</code>s.</p>\n<p>What is\u00a0<strong>mandatory</strong>, however, is the first\u00a0<code>setAttribute()</code>\u00a0line, which tells PDO to disable emulated prepared statements and use\u00a0<em>real</em>\u00a0prepared statements. This makes sure the statement and the values aren&#8217;t parsed by PHP before sending it to the MySQL server (giving a possible attacker no chance to inject malicious SQL).</p>\n<p>Although you can set the\u00a0<code>charset</code>\u00a0in the options of the constructor, it&#8217;s important to note that &#8216;older&#8217; versions of PHP (&lt; 5.3.6)\u00a0<a href=\"http://php.net/manual/en/ref.pdo-mysql.connection.php\" rel=\"noreferrer\">silently ignored the charset parameter</a>\u00a0in the DSN.</p>\n<h2>Explanation</h2>\n<p>What happens is that the SQL statement you pass to\u00a0<code>prepare</code>\u00a0is parsed and compiled by the database server. By specifying parameters (either a\u00a0<code>?</code>\u00a0or a named parameter like\u00a0<code>:name</code>\u00a0in the example above) you tell the database engine where you want to filter on. Then when you call\u00a0<code>execute</code>, the prepared statement is combined with the parameter values you specify.</p>\n<p>The important thing here is that the parameter values are combined with the compiled statement, not an SQL string. SQL injection works by tricking the script into including malicious strings when it creates SQL to send to the database. So by sending the actual SQL separately from the parameters, you limit the risk of ending up with something you didn&#8217;t intend. Any parameters you send when using a prepared statement will just be treated as strings (although the database engine may do some optimization so parameters may end up as numbers too, of course). In the example above, if the\u00a0<code>$name</code>\u00a0variable contains\u00a0<code>'Sarah'; DELETE FROM employees</code>\u00a0the result would simply be a search for the string\u00a0<code>\"'Sarah'; DELETE FROM employees\"</code>, and you will not end up with\u00a0<a href=\"http://xkcd.com/327/\" rel=\"noreferrer\">an empty table</a>.</p>\n<p>Another benefit of using prepared statements is that if you execute the same statement many times in the same session it will only be parsed and compiled once, giving you some speed gains.</p>\n<p>Oh, and since you asked about how to do it for an insert, here&#8217;s an example (using PDO):</p>\n<pre class=\"lang-php prettyprint prettyprinted\"><code>&lt;span class=\"pln\"&gt;$preparedStatement &lt;/span&gt;&lt;span class=\"pun\"&gt;=&lt;/span&gt;&lt;span class=\"pln\"&gt; $db&lt;/span&gt;&lt;span class=\"pun\"&gt;-&amp;gt;&lt;/span&gt;&lt;span class=\"pln\"&gt;prepare&lt;/span&gt;&lt;span class=\"pun\"&gt;(&lt;/span&gt;&lt;span class=\"str\"&gt;'INSERT INTO table (column) VALUES (:column)'&lt;/span&gt;&lt;span class=\"pun\"&gt;);&lt;/span&gt;&lt;span class=\"pln\"&gt;\n\n$preparedStatement&lt;/span&gt;&lt;span class=\"pun\"&gt;-&amp;gt;&lt;/span&gt;&lt;span class=\"pln\"&gt;execute&lt;/span&gt;&lt;span class=\"pun\"&gt;(&lt;/span&gt;&lt;span class=\"pln\"&gt;array&lt;/span&gt;&lt;span class=\"pun\"&gt;(&lt;/span&gt;&lt;span class=\"str\"&gt;'column'&lt;/span&gt; &lt;span class=\"pun\"&gt;=&amp;gt;&lt;/span&gt;&lt;span class=\"pln\"&gt; $unsafeValue&lt;/span&gt;&lt;span class=\"pun\"&gt;));&lt;/span&gt;</code></code></pre>\n<h2>Can prepared statements be used for dynamic queries?</h2>\n<p>While you can still use prepared statements for the query parameters, the structure of the dynamic query itself cannot be parametrized and certain query features cannot be parametrized.</p>\n<p>For these specific scenarios, the best thing to do is use a whitelist filter that restricts the possible values.</p>\n<pre class=\"default prettyprint prettyprinted\"><code>&lt;span class=\"com\"&gt;// Value whitelist&lt;/span&gt;\n&lt;span class=\"com\"&gt;// $dir can only be 'DESC' otherwise it will be 'ASC'&lt;/span&gt;\n&lt;span class=\"kwd\"&gt;if&lt;/span&gt; &lt;span class=\"pun\"&gt;(&lt;/span&gt;&lt;span class=\"pln\"&gt;empty&lt;/span&gt;&lt;span class=\"pun\"&gt;(&lt;/span&gt;&lt;span class=\"pln\"&gt;$dir&lt;/span&gt;&lt;span class=\"pun\"&gt;)&lt;/span&gt; &lt;span class=\"pun\"&gt;||&lt;/span&gt;&lt;span class=\"pln\"&gt; $dir &lt;/span&gt;&lt;span class=\"pun\"&gt;!==&lt;/span&gt; &lt;span class=\"str\"&gt;'DESC'&lt;/span&gt;&lt;span class=\"pun\"&gt;)&lt;/span&gt; &lt;span class=\"pun\"&gt;{&lt;/span&gt;&lt;span class=\"pln\"&gt;\n   $dir &lt;/span&gt;&lt;span class=\"pun\"&gt;=&lt;/span&gt; &lt;span class=\"str\"&gt;'ASC'&lt;/span&gt;&lt;span class=\"pun\"&gt;;&lt;/span&gt;\n&lt;span class=\"pun\"&gt;}&lt;/span&gt;</code></code></pre>\n</div>\n<div class=\"grid mb0 fw-wrap ai-start jc-end gs8 gsy\">\n<div class=\"grid--cell mr16\">\n<div class=\"post-menu\">source :\u00a0https://stackoverflow.com/questions/60174/how-can-i-prevent-sql-injection-in-php</div>\n</div>\n</div>\n", "slug": "how-can-i-prevent-sql-injection-in-php", "date": 1520867180, "cats": [13, 14]}